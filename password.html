<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ‚æ¥µå¯†ç¢¼ </title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-red: #e60012;
            --pure-white: #ffffff;
            --dark-red: #a50000;
        }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-effect { animation: shake 0.5s; animation-iteration-count: infinite; }

        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background-color: var(--primary-red);
            margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh;
        }
        .main-layout { display: flex; gap: 20px; max-width: 1200px; width: 100%; margin-top: 20px; }
        
        .game-container {
            background: var(--pure-white);
            flex: 2; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .player-queue { margin: 20px 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .player-tag { padding: 8px 15px; border: 2px solid #ddd; border-radius: 20px; background: #eee; color: #666; font-weight: bold; }
        .player-tag.active-now { background: var(--primary-red); color: white; border-color: var(--primary-red); transform: scale(1.1); box-shadow: 0 0 10px rgba(230,0,18,0.4); }

        .history-panel { flex: 1; background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 15px; min-height: 500px; border-left: 5px solid var(--primary-red); }

        .setup-section, .game-section { display: none; }
        .active { display: block; }
        
        textarea { padding: 12px; font-size: 16px; border-radius: 5px; border: 2px solid var(--primary-red); margin: 10px 0; width: 90%; }
        input[type="password"], input[type="number"] { padding: 12px; font-size: 20px; border-radius: 5px; border: 2px solid var(--primary-red); margin: 10px 0; width: 60%; text-align: center; }
        
        button { padding: 12px 35px; font-size: 18px; font-weight: bold; cursor: pointer; background: var(--primary-red); color: white; border: none; border-radius: 50px; }
        
        .range-box { font-size: 100px; font-weight: 900; margin: 10px 0; color: var(--primary-red); }
        #heartbeat { font-size: 20px; color: var(--primary-red); font-weight: bold; display: none; animation: beat 0.8s infinite; }
        @keyframes beat { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .record-item { border-bottom: 1px dashed var(--primary-red); padding: 12px 0; font-size: 16px; color: #333; }
        
        .option-group { background: #fff5f5; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #ffcccc; text-align: left; display: inline-block; width: 90%; }
        .option-group label { display: block; cursor: pointer; margin: 5px 0; font-weight: bold; }
    </style>
</head>
<body id="bodyTag">

<div class="main-layout">
    <div class="game-container">
        <div id="setup" class="setup-section active">
            <h1>é·—å€ªçš„å¯†ç¢¼ä¸è¦çŒœ</h1>
            <p>1. è¼¸å…¥åƒåŠ äººå“¡ (æ¯è¡Œä¸€äºº)ï¼š</p>
            <textarea id="playerNames" rows="6" placeholder="é·—å€ª1è™Ÿ&#10;é·—å€ª2è™Ÿ&#10;é·—å€ª3è™Ÿ"></textarea>
            
            <p>2. è¼¸å…¥çæ‡²å…§å®¹ (æ¯è¡Œä¸€é …)ï¼š</p>
            <textarea id="prizes" rows="6" placeholder="å¤©è³1ç§‘&#10;å¤©è³1ç§‘" oninput="updateRoundCount()"></textarea>
            
            <div class="option-group">
                <label><input type="checkbox" id="randomizeOrder" checked> éš¨æ©Ÿç”¢ç”Ÿäººå“¡æ’åº (æ‰“ç ´è¼¸å…¥é †åº)</label>
                <label><input type="checkbox" id="autoExclude" checked> ä¸­çå¾Œè‡ªå‹•å‰”é™¤åå–® (ä¸åƒåŠ ä¸‹ä¸€è¼ª)</label>
            </div>

            <div style="background: #fff5f5; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                é è¨ˆéŠç©å±€æ•¸ï¼š<b id="roundHint" style="font-size: 24px; color: var(--primary-red);">0</b> å±€
            </div>
            <button onclick="initGame()">ç¢ºèªä¸¦é–‹å§‹éŠæˆ²</button>
        </div>

        <div id="game" class="game-section">
            <h2 id="roundTitle">ç¬¬ 1 å±€</h2>
            <div id="queueDisplay" class="player-queue"></div>
            <div id="heartbeat">ğŸ’“ ç·Šå¼µæ™‚åˆ»ï¼æ¥è¿‘ç‚¸å½ˆä¸­... ğŸ’“</div>
            
            <div id="passwordSetup">
                <p>ä¸»æŒäººè«‹è¼¸å…¥ç‚¸å½ˆ (1-100)ï¼š</p>
                <input type="password" id="secret">
                <br><button onclick="confirmSecret()">é–å®šå¯†ç¢¼</button>
            </div>
            
            <div id="playArea" style="display:none;">
                <div class="range-box"><span id="min">1</span> ~ <span id="max">100</span></div>
                <input type="number" id="guess" placeholder="è¼¸å…¥æ•¸å­—">
                <br><button onclick="submitGuess()">é€å‡ºæ•¸å­—</button>
            </div>
        </div>
    </div>

    <div class="history-panel">
        <h3>ğŸ“‹ ç²çæˆ°å ±</h3>
        <div id="historyList"><p style="color:#999;">ç›®å‰å°šç„¡çˆ†ç‚¸ç´€éŒ„...</p></div>
    </div>
</div>

<script>
    let players = [];
    let prizePool = [];
    let totalRounds = 0;
    let currentRound = 1;
    let currentPlayerIndex = 0;
    let secretNum, minBound, maxBound;
    let shouldExclude = true;

    function updateRoundCount() {
        const list = document.getElementById('prizes').value.split('\n').filter(p => p.trim() !== "");
        document.getElementById('roundHint').innerText = list.length;
    }

    // æ´—ç‰Œç®—æ³• (Fisher-Yates Shuffle)
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function initGame() {
        players = document.getElementById('playerNames').value.split('\n').map(n => n.trim()).filter(n => n !== "");
        prizePool = document.getElementById('prizes').value.split('\n').map(p => p.trim()).filter(p => p !== "");
        totalRounds = prizePool.length;
        shouldExclude = document.getElementById('autoExclude').checked;
        const shouldRandom = document.getElementById('randomizeOrder').checked;

        if (players.length < 2) return alert("è«‹è¼¸å…¥è‡³å°‘å…©ä½åƒåŠ äººå“¡ï¼");
        if (totalRounds < 1) return alert("è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹çé …ï¼");

        // éš¨æ©Ÿæ’åºé‚è¼¯
        if (shouldRandom) {
            players = shuffleArray(players);
        }

        document.getElementById('setup').classList.remove('active');
        document.getElementById('game').classList.add('active');
        startNewRound();
    }

    function startNewRound() {
        document.getElementById('roundTitle').innerText = `ç¬¬ ${currentRound} / ${totalRounds} å±€`;
        document.getElementById('passwordSetup').style.display = 'block';
        document.getElementById('playArea').style.display = 'none';
        document.getElementById('heartbeat').style.display = 'none';
        document.getElementById('secret').value = '';
        minBound = 1;
        maxBound = 100;
        
        if (currentPlayerIndex >= players.length) currentPlayerIndex = 0;
        
        renderQueue();
        updateDisplay();
    }

    function renderQueue() {
        const container = document.getElementById('queueDisplay');
        container.innerHTML = '';
        players.forEach((p, index) => {
            const span = document.createElement('span');
            span.className = `player-tag ${index === currentPlayerIndex ? 'active-now' : ''}`;
            span.innerText = p;
            container.appendChild(span);
        });
    }

    function confirmSecret() {
        secretNum = parseInt(document.getElementById('secret').value);
        if (isNaN(secretNum) || secretNum <= 1 || secretNum >= 100) return alert("è«‹è¼¸å…¥ 2-99 ä¹‹é–“çš„æ•¸å­—ï¼");
        document.getElementById('passwordSetup').style.display = 'none';
        document.getElementById('playArea').style.display = 'block';
        updateDisplay();
    }

    function updateDisplay() {
        document.getElementById('min').innerText = minBound;
        document.getElementById('max').innerText = maxBound;
        document.getElementById('heartbeat').style.display = (maxBound - minBound < 15) ? 'block' : 'none';
        renderQueue();
    }

    function triggerShake() {
        document.getElementById('bodyTag').classList.add('shake-effect');
        setTimeout(() => document.getElementById('bodyTag').classList.remove('shake-effect'), 1000);
    }

    function submitGuess() {
        const guessField = document.getElementById('guess');
        const guess = parseInt(guessField.value);

        if (isNaN(guess) || guess <= minBound || guess >= maxBound) {
            alert(`è«‹è¼¸å…¥ ${minBound+1} ~ ${maxBound-1} ä¹‹é–“çš„æ•¸å­—ï¼`);
            return;
        }

        if (guess === secretNum) {
            triggerShake();
            confetti({ particleCount: 200, spread: 90, origin: { y: 0.6 }, colors: ['#e60012', '#ffd700', '#ffffff'] });
            
            const prizeIndex = Math.floor(Math.random() * prizePool.length);
            const prize = prizePool.splice(prizeIndex, 1)[0];
            const loserName = players[currentPlayerIndex];
            
            addRecord(currentRound, loserName, prize);
            
            setTimeout(() => {
                alert(`ğŸ’¥ ç °ï¼ï¼ã€${loserName}ã€‘è§¸ç™¼ç‚¸å½ˆï¼\n\nçå‹µ/æ‡²ç½°ï¼š${prize}`);
                
                if (shouldExclude) {
                    players.splice(currentPlayerIndex, 1);
                    if (currentPlayerIndex >= players.length) currentPlayerIndex = 0;
                } else {
                    currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                }

                if (currentRound < totalRounds) {
                    if (players.length < 2) {
                        alert("å‰©é¤˜ç©å®¶ä¸è¶³ï¼ŒéŠæˆ²çµæŸï¼");
                        showFinal();
                    } else {
                        currentRound++;
                        startNewRound();
                    }
                } else {
                    showFinal();
                }
            }, 600);
        } else {
            if (guess < secretNum) minBound = guess;
            else maxBound = guess;
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            updateDisplay();
        }
        guessField.value = '';
        guessField.focus();
    }

    function addRecord(round, winner, prize) {
        const historyList = document.getElementById('historyList');
        if (currentRound === 1) historyList.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'record-item';
        div.innerHTML = `å±€æ•¸ ${round}ï¼š<b>${winner}</b><br>â”” ğŸ’¥ ${prize}`;
        historyList.prepend(div);
    }

    function showFinal() {
        document.getElementById('playArea').innerHTML = "<h2>ğŸ‰ æ´»å‹•å¤§æˆåŠŸ ğŸ‰</h2><button onclick='location.reload()'>è¿”å›è¨­å®šé é¢</button>";
    }
</script>
</body>
</html>